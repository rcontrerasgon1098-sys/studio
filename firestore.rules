rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funciones de ayuda
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isSignedIn() && getUserData().rol == 'admin';
    }

    function isActive() {
      return isSignedIn() && getUserData().activo == true;
    }

    // Regla de acceso total para administradores
    // Esto permite que consultas de grupo (collectionGroup) funcionen sin errores
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // Perfiles de usuario
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if isSignedIn(); // Permitir creación inicial en login
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Órdenes de trabajo
    match /users/{userId}/work_orders/{workOrderId} {
      allow get, list: if (isSignedIn() && request.auth.uid == userId && isActive()) || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId && isActive();
      allow update: if (isSignedIn() && request.auth.uid == userId && isActive()) || isAdmin();
      allow delete: if isAdmin();
    }

    // Regla para consultas globales (collectionGroup) de órdenes
    match /{path=**}/work_orders/{workOrderId} {
      allow list, get: if isAdmin();
    }

    // Clientes
    match /clients/{clientId} {
      allow get, list: if isSignedIn() && isActive();
      allow create, update, delete: if isAdmin();
    }
  }
}