rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Función para obtener el rol del usuario desde personnel
    function getUserRole() {
      return get(/databases/$(database)/documents/personnel/$(request.auth.uid)).data.rol_t;
    }
    
    // Función para verificar si es administrador
    function isAdmin() {
      return getUserRole() == 'Administrador';
    }
    
    // Función para verificar si es supervisor
    function isSupervisor() {
      return getUserRole() == 'Supervisor';
    }
    
    // Reglas para historial
    match /historial/{document} {
      // Lectura: Admin ve todo, Supervisor solo lo suyo
      allow read: if isAdmin() || (isSupervisor() && resource.data.createdBy == request.auth.uid);
      
      // Escritura: solo administradores y supervisores pueden escribir
      allow write: if request.auth != null && 
        (isAdmin() || isSupervisor());
    }
    
    // Reglas para personnel
    match /personnel/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    // Reglas para clients
    match /clients/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin() || isSupervisor();
    }
    
    // Reglas para ordenes
    match /ordenes/{document} {
      // Lectura: Admin ve todo, Supervisor solo lo suyo
      allow read: if isAdmin() || (isSupervisor() && resource.data.createdBy == request.auth.uid);
      allow write: if isAdmin() || isSupervisor();
    }
    
    // Reglas para roles
    match /roles/{document} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
  }
}
