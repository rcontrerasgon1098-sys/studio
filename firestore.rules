
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda ---
    function isLoggedIn() {
      return request.auth != null;
    }

    // getUserData lee el perfil desde 'personnel' usando el UID del usuario.
    // Esto es más seguro y centraliza los roles.
    function getUserData() {
      // Esta función asume que el documento en 'personnel' tiene el mismo ID que el UID del usuario.
      return get(/databases/$(database)/documents/personnel/$(request.auth.uid)).data;
    }

    function isAdmin() {
      // El campo debe ser 'role' y el valor 'admin' en el documento de 'personnel'
      return isLoggedIn() && getUserData().role == "admin";
    }

    function isSupervisor() {
      return isLoggedIn() && getUserData().role == "supervisor";
    }
    
    // ===============================
    // PERSONNEL (PERFILES - Fuente de Verdad para roles)
    // ===============================
    match /personnel/{personId} {
      // get: Permite leer un documento. Esencial para que getUserData() funcione.
      // Un usuario puede leer su propio perfil.
      // Un admin puede leer cualquier perfil.
      allow get: if (isLoggedIn() && request.auth.uid == personId) || isAdmin();
      
      // list: Permite consultar la colección.
      // Admins y Supervisores necesitan esto para listar personal.
      allow list: if isAdmin() || isSupervisor();
      
      // write: Solo los admins pueden crear, actualizar o borrar perfiles.
      allow write: if isAdmin();
    }
    
    // ===============================
    // USERS (Colección de caché, no usada para reglas críticas)
    // ===============================
    match /users/{userId} {
      // Se permite al sistema escribir al hacer login y al usuario leer su propio doc.
      // Admin puede leer/escribir todo para mantenimiento.
      allow read, write: if isAdmin() || (isLoggedIn() && request.auth.uid == userId);
    }

    // ===============================
    // CLIENTS
    // ===============================
    match /clients/{clientId} {
      allow read: if isAdmin() || isSupervisor();
      // Admin y Supervisores pueden crear/editar clientes.
      allow write: if isAdmin() || isSupervisor();
    }

    // ===============================
    // ORDENES (ACTIVAS)
    // ===============================
    match /ordenes/{ordenId} {
      // list: Permite a Admin y Supervisor consultar la colección (para filtrar en la app).
      allow list: if isAdmin() || isSupervisor();
      // get: Admin puede leer cualquier orden, Supervisor solo las suyas.
      allow get: if isAdmin() || (isSupervisor() && resource.data.createdBy == request.auth.uid);
      
      // create: Supervisor solo puede crear órdenes asociadas a su UID.
      allow create: if isSupervisor() && request.resource.data.createdBy == request.auth.uid;
      
      // update: Supervisor solo puede actualizar sus propias órdenes si están 'Pending'.
      allow update: if isSupervisor() && resource.data.createdBy == request.auth.uid && resource.data.status == "Pending";
      
      // delete: Solo Admin puede borrar.
      allow delete: if isAdmin();
    }

    // ===============================
    // HISTORIAL (OT CERRADAS)
    // ===============================
    match /historial/{historialId} {
      // list & get: Admin puede ver todo. Supervisor solo sus propias órdenes completadas.
      allow list: if isAdmin() || isSupervisor();
      allow get: if isAdmin() || (isSupervisor() && resource.data.createdBy == request.auth.uid);
      
      // write: Solo Admin puede modificar el historial.
      allow write: if isAdmin();
    }

    // ===============================
    // ROLES
    // ===============================
    match /roles/{roleId} {
      // Necesario para poblar los dropdowns en la UI
      allow read: if isLoggedIn();
      // Solo Admin puede editar la definición de roles.
      allow write: if isAdmin();
    }
  }
}
