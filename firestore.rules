rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isLoggedIn() {
      return request.auth != null;
    }

    function userData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isLoggedIn() && userData().role == "admin";
    }

    function isSupervisor() {
      return isLoggedIn() && userData().role == "supervisor";
    }

    function isTecnico() {
      return isLoggedIn() && userData().role == "tecnico";
    }

    // ===============================
    // USERS
    // ===============================
    match /users/{userId} {

      // admin puede ver todos los usuarios
      // supervisor solo puede leer su perfil
      allow read: if isAdmin() || (isSupervisor() && request.auth.uid == userId);

      // solo admin crea, actualiza y borra usuarios
      allow write: if isAdmin();
    }

    // ===============================
    // CLIENTS
    // ===============================
    match /clients/{clientId} {
      allow read: if isAdmin() || isSupervisor();
      allow write: if isAdmin();
    }

    // ===============================
    // PERSONNEL (tecnicos / trabajadores)
    // ===============================
    match /personnel/{personId} {
      // admin puede ver y editar todo
      // supervisor solo puede leer (para seleccionar t√©cnicos)
      allow read: if isAdmin() || isSupervisor();
      allow write: if isAdmin();
    }

    // ===============================
    // ORDENES ACTIVAS
    // ===============================
    match /ordenes/{ordenId} {

      // ADMIN VE TODO
      allow read, write: if isAdmin();

      // SUPERVISOR SOLO VE SUS ORDENES
      // Usamos 'list' para la consulta y 'get' para documentos individuales
      allow list: if isSupervisor();
      allow get: if isSupervisor() && resource.data.createdBy == request.auth.uid;

      // SUPERVISOR SOLO PUEDE CREAR ORDENES SUYAS
      allow create: if isSupervisor()
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.status in ["Pending", "Completed"];

      // SUPERVISOR SOLO PUEDE EDITAR SI ES SUYA Y SI NO ESTA CERRADA
      allow update: if isSupervisor()
        && resource.data.createdBy == request.auth.uid
        && resource.data.status in ["Pending", "Completed"];
      
      // SUPERVISOR no puede borrar, solo ADMIN
      allow delete: if isAdmin();
    }

    // ===============================
    // HISTORIAL (OT cerradas)
    // ===============================
    match /historial/{historialId} {

      // admin ve todo
      allow read, write: if isAdmin();

      // supervisor solo ve historial de sus propias OT
      allow list: if isSupervisor();
      allow get: if isSupervisor() && resource.data.createdBy == request.auth.uid;

      // supervisor no puede escribir/borrar historial
      allow write: if false;
    }

    // ===============================
    // ROLES (admin escribe, todos leen)
    // ===============================
    match /roles/{roleId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }
  }
}
