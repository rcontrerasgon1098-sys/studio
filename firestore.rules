
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda ---
    function isLoggedIn() {
      return request.auth != null;
    }

    // getUserData lee el perfil desde 'personnel' usando el UID del usuario.
    // Esto es más seguro y centraliza los roles.
    function getUserData() {
      // Esta función asume que el documento en 'personnel' tiene el mismo ID que el UID del usuario.
      return get(/databases/$(database)/documents/personnel/$(request.auth.uid)).data;
    }

    function isAdmin() {
      // El campo debe ser 'rol_t' y el valor 'Administrador'
      return isLoggedIn() && getUserData().rol_t == "Administrador";
    }

    function isSupervisor() {
      return isLoggedIn() && getUserData().rol_t == "Supervisor";
    }
    
    // ===============================
    // PERSONNEL (PERFILES - Fuente de Verdad para roles)
    // ===============================
    match /personnel/{personId} {
      // get: Permite leer un documento. Esencial para que getUserData() funcione.
      // Un usuario puede leer su propio perfil.
      // Un admin puede leer cualquier perfil.
      allow get: if (isLoggedIn() && request.auth.uid == personId) || isAdmin();
      
      // list: Permite consultar la colección.
      // Admins y Supervisores necesitan esto para listar personal.
      allow list: if isAdmin() || isSupervisor();
      
      // write: Solo los admins pueden crear, actualizar o borrar perfiles.
      allow write: if isAdmin();
    }
    
    // ===============================
    // CLIENTS
    // ===============================
    match /clients/{clientId} {
      allow read, write: if isAdmin() || isSupervisor();
    }

    // ===============================
    // ORDENES (ACTIVAS)
    // ===============================
    match /ordenes/{ordenId} {
      // list: Permite a Admin y Supervisor consultar la colección (para filtrar en la app).
      allow list: if isAdmin() || isSupervisor();
      // get: Admin puede leer cualquier orden, Supervisor solo las suyas.
      allow get: if isAdmin() || (isSupervisor() && resource.data.createdBy == request.auth.uid);
      
      // create: Supervisor solo puede crear órdenes asociadas a su UID.
      allow create: if isSupervisor() && request.resource.data.createdBy == request.auth.uid;
      
      // update: Supervisor solo puede actualizar sus propias órdenes si están 'Pending'.
      allow update: if isSupervisor() && resource.data.createdBy == request.auth.uid && resource.data.status == "Pending";
      
      // delete: Solo Admin puede borrar.
      allow delete: if isAdmin();
    }

    // ===============================
    // HISTORIAL (OT CERRADAS)
    // ===============================
    match /historial/{historialId} {
      // list & get: Admin puede ver todo. Supervisor solo sus propias órdenes completadas.
      allow list: if isAdmin() || isSupervisor();
      allow get: if isAdmin() || (isSupervisor() && resource.data.createdBy == request.auth.uid);
      
      // write: Solo Admin puede modificar el historial.
      allow write: if isAdmin();
    }
  }
}
